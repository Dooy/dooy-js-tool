/*!
 * version: 0.1.5
 * docs: https://github.com/Dooy/dooy-js-tool
 * 
 */!function(e){var t={};function r(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(s,n,function(t){return e[t]}.bind(null,n));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1)}([function(e,t){const r={dateFormat(e,t){let r=new Date;return arguments.length<=1||(r=this.parseDate(t)),this.dateFormatDone(e,r)},parseDate(e){try{if("number"==typeof e&&e>0)return new Date(1e3*e);if("string"==typeof e){if(Date.parse(e))return new Date(e)}else if(e.constructor==Date)return e}catch(e){}throw"必须是时间戳、日期字符、时间类型三者其一"},dateFormatDone:(e,t)=>(Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var r in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+r+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[r]:("00"+t[r]).substr((""+t[r]).length)));return e},t.format(e)),timeToDate(e,t){let r=new Date(1e3*e);return this.dateFormatDone(t,r)},nowStr(e){let t=Math.round(new Date/1e3),r=t-e;return r<120?"刚刚":r<1800?Math.round(r/60)+"分钟前":r<2400?"半小时前":this.timeToDate(t,"yyyy-MM-dd")==this.timeToDate(e,"yyyy-MM-dd")?r<43200?Math.round(r/3600)+"小时前":this.timeToDate(e,"hh:mm"):r<172800?"1天前":r<259200?"2天前":r<345600?"3天前":this.timeToDate(e,"yyyy-MM-dd")},now(e){let t=Math.round(this.parseDate(e)/1e3);return this.nowStr(t)},getQueryStr(e){var t,r=location.href;return(t=new RegExp("(^|)"+e+"=([^&]*)(&|$)","gi").exec(r))?t[2]:""},isFunction:e=>"function"==typeof e,isDefined:e=>!(void 0===e),isObject:e=>"object"==typeof e,inArray(e,t){for(let r in t)if(t[r]===e)return!0;return!1},extend(e,t){let r=1;arguments.length>2&&(r=arguments[2]);const s=e;if(!this.isObject(t))return s;for(let e in t){if(this.isDefined(s[e]))this.inArray(r,[1,3])&&(s[e]=t[e]);else{this.inArray(r,[2,3])&&(s[e]=t[e])}}return s},numStr(e){if(e=parseInt(e),isNaN(e))throw"输入必须是一个数字";return e<2e3?e:e<1e4?Math.ceil(e/100-.5)/10+"K":e<5e5?Math.ceil(e/1e3-.5)/10+"W":e<1e7?Math.ceil(e/1e4-.5)+"W":e<1e8?Math.ceil(e/1e6-.5)/10+"KW":Math.ceil(e/1e7-.5)/10+"亿"}};e.exports=r},function(e,t,r){"use strict";var s=r(0),n=r(2),i=r(3),a={tool:s,pigaiEs:r(4),es:{init:function(e){e.axios,e.esServer;return new i(arguments[0])}},cos:{init:function(e){e.COS,e.callback,e.stsMyServer,e.cosCdn,e.Bucket,e.Region;return new n(arguments[0])}}};window.dooy=a},function(e,t,r){const s=r(0);e.exports=class{constructor({COS:e,callback:t,stsMyServer:r,cosCdn:n,Bucket:i,Region:a}){this.COS=e,this.config={callback(){},stsMyServer:"/?c=mpad&a=cos&do=1",cosCdn:"//cos.pigai.org",Bucket:"pigaicos-1255341547",Region:"ap-nanjing"},this.initRdate(),arguments.length>0&&s.extend(this.config,arguments[0])}initRdate(){this.rdata={error:0,error_des:"",data:{}}}upload(e,{callFun:t,onProgress:r}){if(this.initRdate(),s.isFunction(t)&&(this.config.callback=t),arguments.length>2)for(let e in arguments[2])config[e]&&(config[e]=arguments[2][e]);let n=this.getCos(t),i=e.name,a=i.substring(i.lastIndexOf("."));if(!this.getExt(a))return!1;var o=this.getFileName(a);console.log("fname>>",o),n.uploadFile({Bucket:this.config.Bucket,Region:this.config.Region,Key:o,Body:e,SliceSize:15728640,onProgress:e=>{s.isFunction(r)&&r(e)}},(t,r)=>{if(console.log("上传"+(t?"失败":"完成")),console.log("uploadFile:",t||r),t)this.error(404,"上传失败 ["+t+"]");else{let t={f:o,fdes:e.name,fhttp:this.config.cosCdn+"/"+o};this.success(t)}})}getCos(){return new this.COS({getAuthorization:(e,t)=>{var r=this.config.stsMyServer,s=new XMLHttpRequest;s.open("GET",r,!0),s.onload=e=>{try{var r=JSON.parse(e.target.responseText),s=(r=r.Response).Credentials}catch(e){}if(!r||!s)return this.error(401,"凭证错误"),console.error("credentials invalid:\n"+JSON.stringify(r,null,2));t({TmpSecretId:s.TmpSecretId,TmpSecretKey:s.TmpSecretKey,SecurityToken:s.Token,ExpiredTime:r.ExpiredTime})},s.send()}})}getFileName(e){return"cup/"+s.dateFormat("yyyy/MM/dd")+"/"+function(e){let t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];for(var r="",s=0;s<e;s++){r+=t[Math.ceil(35*Math.random())]}return r}(8)+e}getExt(e){let t="doc,docx,ppt,ppt,xls,xxls,xlsx,vsd,pot,pps,rtf,wps,et,dps,pdf,rar,zip,tgz,tar,jpg,png,gif,jpe,jpeg".split(",");for(let r in t){if("."+t[r]==e.toLocaleLowerCase())return!0}return this.error(402,e+" 格式不支持"),!1}error(e,t){this.rdata.error=e,this.rdata.error_des=t,this.rdata.data={},this.doCallBack()}success(e){this.rdata.error=0,this.rdata.error_des="",this.rdata.data=e,this.doCallBack()}doCallBack(){this.config.callback(this.rdata)}}},function(e,t,r){const s=r(0);class n{constructor(e){this.buckets=e}getObjectByKey(e){for(let t in this.buckets){let r=this.buckets[t];if(r.key==e)return r;if(void 0!==r.key_as_string&&r.key_as_string==e)return r}return null}init(e){return new n(e)}getValue(){let e=[];for(let t in this.buckets){let r=this.buckets[t],n={key:r.key_as_string||r.key,doc_count:r.doc_count};for(let e in r)s.isDefined(r[e].value)&&(n[e]=r[e].value);e.push(n)}return e}}e.exports=class{constructor({axios:e,esServer:t="/_sql"}){this.axios=e,this.esServer=t}request(e){return this.axios({headers:{"Content-Type":"application/json;charset=utf-8"},url:this.esServer,method:"post",responseType:"json",data:e})}createBuckets(e){return new n(arguments[0])}when(e,t){let r=[];for(let t in e)r.push(this.request(e[t]));let s=this.axios;return s.all(r).then(s.spread(t))}}},function(e,t){e.exports=class{constructor(e,t,{school:r="",rank:s="year",etime:n="",stime:i="2010-01-01",where:a={}}){this.es=e,this._=t,this.cf={school:r,rank:s,stime:i,etime:n,where:a},this._rq=[]}_rank(){let e=(arguments.length>0?arguments[0]:{}).rank||this.cf.rank;return["d","D","day","DAY"].indexOf(e)>-1?"date_histogram(field='ctime','interval'='1d','alias'='ctime',format='yyyy-MM-dd')":["w","W","week","WEEK"].indexOf(e)>-1?"date_histogram(field='ctime','interval'='1w','alias'='ctime',format='yyyy-MM-dd')":["m","M","month","MONTH"].indexOf(e)>-1?"date_histogram(field='ctime','interval'='1M','alias'='ctime',format='yyyy-MM')":"date_histogram(field='ctime','interval'='1y','alias'='ctime',format='yyyy年')"}getGWhere(){let e=[],t=arguments.length>0?arguments[0]:{},r=t.school||this.cf.school,s=t.stime||this.cf.stime,n=t.etime||this.cf.etime,i=t.where||this.cf.where;r&&e.push(this._whereIn("school",r)),e.push("ctime>='"+s+"'"),n&&e.push("ctime<'"+n+"'");for(let t in i)e.push(this._whereIn(t,i[t]));return e.join(" AND ")}_whereIn(e,t){return"string"==typeof t?e+"='"+t+"'":e+" in('"+t.join("','")+"')"}getMember(){let e="select ts,rz,count(*) as cnt from pigaimember where "+(arguments.length>0?this.getGWhere(arguments[0]):this.getGWhere())+" group by  ts,rz ";return this._initRq(e,"getMember"),this}_parseMember(e){let t={total:0,teacher_rz:0,teacher:0,student:0};t.total=e.data.hits.total;let r=this.es,s=r.createBuckets(e.data.aggregations.ts.buckets).getObjectByKey("1");if(s){t.teacher=s.doc_count;let e=r.createBuckets(s.rz.buckets).getObjectByKey("");e&&(t.teacher_rz=s.doc_count-e.doc_count)}return t.student=t.total-t.teacher,t}_parse(e){this.es;let t={};try{for(let r in e.data.aggregations){let s=e.data.aggregations[r];this._.isUndefined(s.value)||(t[r]=s.value)}}catch(e){}return t}_parseRank(e){return this.es.createBuckets(e.data.aggregations.ctime.buckets).getValue()}_parseRankMember(e){let t=this.es,r=t.createBuckets(e.data.aggregations.ctime.buckets),s=r.getValue();for(let e in r.buckets){s[e].total=s[e].doc_count;let n=t.createBuckets(r.buckets[e].ts.buckets).getObjectByKey("1");s[e].teacher_cnt=n?n.doc_count:0,s[e].student_cnt=s[e].total-s[e].teacher_cnt}return console.log("bk1>>",s),s}getEssay(){let e={all:0};arguments.length>0&&this._.extend(e,arguments[0]);let t=arguments.length>0?this.getGWhere(arguments[0]):this.getGWhere(),r="";e.all&&(r=" ,count(distinct user_id) as s_user_cnt,count(distinct request_id) as s_rq_cnt  ");let s="select count(*) as essay_cnt,sum(version) as version "+r+" from pigaiessay where  "+t;return this._initRq(s,"getEssay"),this}getRequest(){let e="select count(distinct user_id) as t_user_cnt,count(*) as rq_cnt,sum(essay_cnt) as t_essay_cnt from pigairequest where "+(arguments.length>0?this.getGWhere(arguments[0]):this.getGWhere());return this._initRq(e,"getRequest"),this}_initRq(e,t){this.es;this._rq.push({sql:e,source:t})}then(e){let t=this._.map(this._rq,"sql"),r={};this._.extend(r,this._rq),this._rq=[];let s=this;return this.es.when(t,(function(){for(let e in arguments)r[e].time=arguments[e].data.took,r[e].time_out=arguments[e].data.time_out?1:0,"getMember"==r[e].source?r[e].data=s._parseMember(arguments[e]):["getRequest","getEssay"].indexOf(r[e].source)>-1?r[e].data=s._parse(arguments[e]):["rankRequest","rankEssay"].indexOf(r[e].source)>-1?r[e].data=s._parseRank(arguments[e]):["rankMember"].indexOf(r[e].source)>-1?r[e].data=s._parseRankMember(arguments[e]):r[e].data=arguments[e].data;e(r)}))}rankRequest(){let e="select ctime,count(distinct user_id) as t_user_cnt,count(*) as rq_cnt,sum(essay_cnt) as t_essay_cnt from pigairequest where "+(arguments.length>0?this.getGWhere(arguments[0]):this.getGWhere());return e+=" group by "+this._rank(arguments.length>0?arguments[0]:{}),this._initRq(e,"rankRequest"),this}rankEssay(){let e={all:0};arguments.length>0&&this._.extend(e,arguments[0]);let t=arguments.length>0?this.getGWhere(arguments[0]):this.getGWhere(),r="";e.all&&(r=" ,count(distinct user_id) as s_user_cnt,count(distinct request_id) as s_rq_cnt  ");let s="select ctime, count(*) as essay_cnt,sum(version) as version "+r+" from pigaiessay where  "+t;return s+=" group by "+this._rank(arguments.length>0?arguments[0]:{}),this._initRq(s,"rankEssay"),this}rankMember(){let e="select ctime, ts,count(*) as user_cnt from pigaimember where "+(arguments.length>0?this.getGWhere(arguments[0]):this.getGWhere())+" group by  ";return e+=" "+this._rank(arguments.length>0?arguments[0]:{}),e+=",ts",this._initRq(e,"rankMember"),this}concat(e,t,r){let s=[],n={},i=this._;"request"==r&&(n={rq_cnt:0,t_user_cnt:0,t_essay_cnt:0}),"member"==r&&(n={teacher_cnt:0,total:0,student_cnt:0}),"essay"==r&&(n={essay_cnt:0,version:0,s_user_cnt:0,s_rq_cnt:0});for(let r in e){let a={};i.extend(a,e[r]);let o=i.findIndex(t,{key:e[r].key});i.extend(a,o>-1?t[o]:n),s.push(a)}return s}}}]);